name: Build and Deploy
on: 
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [16.x]

    steps:
      - uses: actions/checkout@v3

      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.node-version }}
      - run: npm ci
      - run: yarn install
      - run: yarn vuepress:build

      # # 缓存 node_modules
      # - name: Cache dependencies
      #   uses: actions/cache@v2
      #   id: yarn-cache
      #   with:
      #     path: |
      #       **/node_modules
      #     key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}
      #     restore-keys: |
      #       ${{ runner.os }}-yarn-

      # # 如果缓存没有命中，安装依赖
      # - name: Install dependencies
      #   if: steps.yarn-cache.outputs.cache-hit != 'true'
      #   run: yarn --frozen-lockfile

      # # 运行构建脚本
      # - name: Build VuePress site
      #   run: yarn vuepress:build

      # # 查看 workflow 的文档来获取更多信息
      # # @see https://github.com/crazy-max/ghaction-github-pages
      # - name: Deploy to GitHub Pages
      #   uses: crazy-max/ghaction-github-pages@v2
      #   # 环境变量
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.ACCESS_TOKEN }}
      #   with:
      #     # 部署到 gh-pages 分支
      #     target_branch: gh-pages
      #     # 部署目录为 VuePress 的默认输出目录
      #     build_dir: docs/.vuepress/dist




      - name: Init new repo in dist folder and commit generated files
        run: |
          cd docs/.vuepress/dist
          git init
          git add -A
          git config --local user.email "1084662708@qq.com"
          git config --local user.name "sword4869"
          git commit -m 'deploy'

      - name: Force push to destination branch
        uses: ad-m/github-push-action@v0.5.0
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          # this might change depending on whether you are publishing a site for a normal repo or a user/organization repo
          branch: gh-pages
          force: true
          directory: ./docs/.vuepress/dist

# jobs:
#   build-and-deploy:
#     runs-on: ubuntu-22.04
#     steps:
    
#     - name: Checkout
#       uses: actions/checkout@v2

#     - name: vuepress-deploy
#       uses: jenkey2011/vuepress-deploy@master
#       env:
#         ACCESS_TOKEN: ${{ secrets.ACCESS_TOKEN }}
#         TARGET_BRANCH: gh-pages
#         BUILD_SCRIPT: yarn install && yarn vuepress:build
#         BUILD_DIR: docs/.vuepress/dist/
    
# -----------------------------想不通为什么下面的失败了, /node_modules/mini-css-extract-plugin/dist/loader.js----------------------------------------
# - name: Setup Node.js
#   uses: actions/setup-node@v1
#   with:
#     node-version: 16

# - name: vuepress build
#   run: |
#     yarn install
#     yarn vuepress:build

# - name: gitpush
#   # 将构建产物 commit 到一个分支上，用于发布静态站点资源
#   # https://github.com/peaceiris/actions-gh-pages
#   uses: peaceiris/actions-gh-pages@v3
#   with:
#     # Github 会在 workflow 中自动生成 GIHUBT_TOKEN，用于认证 workflow 的运行
#     github_token: ${{ secrets.ACCESS_TOKEN }}
#     # 静态资源目录设置
#     publish_dir: docs/.vuepress/dist/
#     # 默认发布到 gh-pages 分支上，可以指定特定的发布分支（不能选拉取代码的分支）
#     publish_branch: gh-pages
#     full_commit_message: ${{ github.event.head_commit.message }}